# Provvypay Production Infrastructure on Render
# 
# Phase 1 Deployment: Web Service Only
# Worker and cron services will be added in Phase 2
#
# Services:
#   - Web: Next.js API server
#   - Worker: Background job processor (Xero sync, retries) [DISABLED]
#   - Cron: Scheduled tasks (FX rates, reconciliation) [DISABLED]
#   - Database: Native Postgres
#
# Setup:
#   1. Create Environment Group "provvypay-production" in Render dashboard
#   2. Add all variables from .env.production to the group
#   3. Push this file to GitHub
#   4. In Render: New + → Blueprint → Connect repo → Apply
#   5. After deployment: Shell into web service → npx prisma migrate deploy

services:
  # Main API Server
  - type: web
    name: provvypay-api
    env: node
    region: oregon
    plan: starter
    branch: main
    rootDir: src
    buildCommand: npm ci && npx prisma generate && npm run build
    startCommand: npm run start
    healthCheckPath: /api/health
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: provvypay-db
          property: connectionString
      - fromGroup: provvypay-production

  # Background Worker - DISABLED FOR PHASE 1
  # - type: worker
  #   name: provvypay-worker
  #   env: node
  #   region: oregon
  #   plan: starter
  #   branch: main
  #   rootDir: src
  #   buildCommand: npm ci && npx prisma generate
  #   startCommand: npm run worker
  #   envVars:
  #     - key: NODE_ENV
  #       value: production
  #     - key: DATABASE_URL
  #       fromDatabase:
  #         name: provvypay-db
  #         property: connectionString
  #     - fromGroup: provvypay-production

  # Cron: FX Rates (Hourly) - DISABLED FOR PHASE 1
  # - type: cron
  #   name: provvypay-cron-fx
  #   env: node
  #   region: oregon
  #   schedule: "0 * * * *"
  #   branch: main
  #   rootDir: src
  #   buildCommand: npm ci && npx prisma generate
  #   startCommand: npm run cron:fx-rates
  #   envVars:
  #     - key: DATABASE_URL
  #       fromDatabase:
  #         name: provvypay-db
  #         property: connectionString
  #     - fromGroup: provvypay-production

  # Cron: Reconciliation (Daily 2 AM) - DISABLED FOR PHASE 1
  # - type: cron
  #   name: provvypay-cron-reconcile
  #   env: node
  #   region: oregon
  #   schedule: "0 2 * * *"
  #   branch: main
  #   rootDir: src
  #   buildCommand: npm ci && npx prisma generate
  #   startCommand: npm run cron:reconcile
  #   envVars:
  #     - key: DATABASE_URL
  #       fromDatabase:
  #         name: provvypay-db
  #         property: connectionString
  #     - fromGroup: provvypay-production

databases:
  - name: provvypay-db
    databaseName: provvypay_production
    user: provvypay
    region: oregon
    plan: basic

